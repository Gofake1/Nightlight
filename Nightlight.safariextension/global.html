<script>
function handleValidate(event) {
  event.target.disabled = !event.target.browserWindow.activeTab.url;
}

function handleSettings(event) {
  switch (event.key) {
  case 'autoOn':
    if (event.newValue === true) {
      console.log('autoOn true');
      startTimerForMode('on', safari.extension.settings.onTime);
      startTimerForMode('off', safari.extension.settings.offTime);
    } else {
      console.log('autoOn false');
      window.clearInterval(onInterval);
      window.clearInterval(offInterval);
    }
    break;
  case 'onTime':
  case 'offTime':
    console.log('autoOn time changed');
    window.clearInterval(onInterval);
    window.clearInterval(offInterval);
    startTimerForMode('on', safari.extension.settings.onTime);
    startTimerForMode('off', safari.extension.settings.offTime);
    break;
  }
}

function timeFromString(str) {
  var tokens = str.split(':');
  var now = new Date();
  return new Date(now.getFullYear(), now.getMonth(), now.getDate(), tokens[0], tokens[1], 0, 0);
}

function startTimerForMode(mode, time) {
  var now = new Date();
  var timeUntilMode = timeFromString(time) - now;
  timeUntilMode += (timeUntilMode < 0 ? 86400000 : 0);
  // Timeout until set time, then repeat everyday
  window.setTimeout(function() {
    if (mode == 'on') {
      console.log('timeout turned on Nightlight');
      safari.extension.settings.isOn = true;
      onInterval = window.setInterval(function() {
        console.log('interval turned on Nightlight');
        safari.extension.settings.isOn = true;
      }, 86400000);
    } else {
      console.log('timeout turned off Nightlight');
      safari.extension.settings.isOn = false;
      offInterval = window.setInterval(function() {
        console.log('interval turned off Nightlight');
        safari.extension.settings.isOn = false;
      }, 86400000);
    }
  }, timeUntilMode);
  console.log(mode+' timeout started');
}

safari.application.addEventListener('validate', handleValidate, false);
safari.extension.settings.addEventListener('change', handleSettings, false);
var onInterval, offInterval;
if (safari.extension.settings.autoOn === true) {
  console.log('autoOn true');
  startTimerForMode('on', safari.extension.settings.onTime);
  startTimerForMode('off', safari.extension.settings.offTime);
}
</script>